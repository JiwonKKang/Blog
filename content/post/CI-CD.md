---
title: "무중단 배포는 어떻게할까?"
date: 2023-08-11T09:25:40+09:00
draft: false
pin: false
summary: "여러가지 배포의 종류를 알아보자"
tags: [devops]
---
> # 1. 무중단 배포란?

말 그대로 애플리케이션의 중단 없이 배포를 하는 것을 말한다. 

애플리케이션은 언제 중단될까?

![](https://blog.kakaocdn.net/dn/4LHzl/btrjoPFRmwo/zDml1uhgVGe65FcPMulZ80/img.png)

v1 서비스가 실행 중일 때 v2 버전을 다운로드 받는다.  
v1 서비스를 종료 시키는 시점부터 v2를 시작하기 전까지 애플리케이션은 중단된다.  
이렇게 서비스가 중단되는 시간을 **다운타임(downtime)**이라고 한다.

## 무중단 배포의 종류

무중단 배포에는 크게 3가지 기법이 있다.

![배포 종류](/images/CI-CD/ci.png)

아래에서 자세히 알아보자
<br>

> # 2. 무중단 배포 기법

## 블루-그린 배포

![블루-그린](/images/CI-CD/blue-green.gif)
블루는 구버전, 그린은 신버전을 의미한다.

운영중인 구버전과 동일하게 신버전의 인스턴스를 구성한 후 **로드밸런서를 통해 모든 트래픽을 한번에 신버전 쪽으로 전환**하는 방식이다.

장점.

- 구버전의 인스턴스가 그대로 남아있어서 손쉬운 롤백이 가능하다.
- 구버전의 환경을 다음 배포에 재사용할 수 있다.
- 운영환경에 영향을 주지 않고 새 버전 테스트 가능.

단점.

- **시스템 자원이 두배로 필요하다.**
- 새로운 환경에 대한 테스트가 전제되어야 한다.

## 롤링배포

![롤링](/images/CI-CD/img.gif)
롤링 배포는 **사용 중인 인스턴스 내에서 새 버전을 점진적으로 교체**하는 것으로 무중단 배포의 가장 기본적인 방식이다.

서비스 중인 인스턴스 하나를 로드밸런서에서 라우팅하지 않도록 한 뒤, 새 버전을 적용하여 다시 라우팅하도록 한다.

이를 반복하여 모든 인스턴스에 새 버전의 애플리케이션을 배포한다.

위 움짤을 보면

1. 4개의 기존 버전(v0.0.1)이 있다.

2. 그 중에 2개의 라우팅을 끊고 업데이트 버전(v0.0.2)로 업그레이드 한다.

3. 업데이트 버전이 배포가 되면 다시 라우팅을 시작한다.

4. 나머지 2개 인스턴스의 라우팅을 끊고 업데이트 버전을 배포한다.

5. 나머지 2개의 인스턴스의 업데이트가 끝나면 다시 라우팅을 연결한다.

장점

- 인스턴스마다 차례로 배포를 진행하기에 상황에 따라 손쉽게 롤백이 가능하다.
- 추가적인 인스턴스를 늘리지 않아도 된다.
- 간편한 관리

단점

- 새 버전을 배포할때 인스턴스의 수가 감소하기 때문에 **사용중인 인스턴스에 트래픽이 몰릴 수 있다.** 즉, 서비스 처리 용량을 고려해야 한다. 위 움짤에서 2번과정, 4번과정에서 4개의 인스턴스에서 감당하던 트래픽이 2개의 인스턴스로 몰리는 경우이다.
- 배포가 진행될때 구버전과 신버전이 공존하기에 **호환성 문제**가 발생할 수 있다. 위 움짤에서 3번과정에서 업데이트 된 버전2개, 안된버전 2개가 공존하므로 사용자들은 균일한 서비스를 받지 못한다.

## 카나리 배포

![kanari](/images/CI-CD/kanari.gif)
옛날 광부들이 유독 가스에 민감한 카나리아 새를 이용해 가스 누출 위험을 감지했던 것에서 유래한 것으로 잠재적 문제 상황을 미리 발견하기 위한 방식이다.

신버전을 소수의 유저들에게만 배포를 해보고 문제가 없는것을 확인해가며 점차 많은 유저들에게 배포하는 기법이다.

블루그린 배포와 유사하지만 블루그린처럼 **트래픽을 한번에 확 바꾸는 것이 아니라 단계적으로 전환**하기에 부정적 영향을 최소화하고 상황에 따라 트래픽 양을 조절하며 롤백할 수 있다.

장점.

- 문제 상황을 빠르게 감지
- A/B 테스트로 활용 가능

단점.

- 네트워크 트래픽 제어 부담.

*A/B 테스트란? 

대조군과 실험군으로 나누어서 특정한 UI나 알고리즘의 효과를 비교하는 방법론

> # 정리

1. Rolling 배포

![](https://blog.kakaocdn.net/dn/b5ONmL/btrjmVfi7Lb/w1nRewhZTBN39ydbnbVToK/img.png)

- 인스턴스를 늘리지 않고,
- 하나씩 새로운 버전으로 늘리는 기법.
- 사용중인 인스턴스에 트래픽이 몰리는 문제가 있다.
- 버전간 호환성 문제가 생기는 순간이 있다.

2. Blue Green 배포

![](https://blog.kakaocdn.net/dn/dAUFUz/btrjjQNguQL/IFp7c0CXy5IS7Mrzhkbji1/img.png)

배포 전

![](https://blog.kakaocdn.net/dn/cSUemw/btrjkD0YcME/L3gplugLTxlfkbGaLMy36K/img.png)

배포 후

- 구버전과 같은 환경으로 신버전을 미리 준비.
- 로드밸런서의 라우팅을 한번에 확! 전환시킴.
- 구버전의 환경을 재활용하거나 롤백하기 쉬움.
- 단, 시스템 자원이 두배로 든다.

3. 카나리 배포

![](https://blog.kakaocdn.net/dn/b20erI/btrjkyyRFbR/hZSOAFHXlEc9y3smXZbID1/img.png)

- 소수만 사용하는 환경에 신버전을 배포하고 문제를 관찰한다.
- 문제가 없으면 신버전으로의 트래픽을 단계적으로 늘린다.
- 블루그린 배포와 유사. 하지만 블루그린은 한번에 전환, 이건 단계적으로 전환.
- 문제를 빠르게 발견할 수 있다.

---
> **참고**

~~~
서버는 stateless해야한다. 왜냐하면 오토 스케일링으로 서버가 늘어날때 
어떤 서버로 들어와도 같은동작을 해야함

만약 특정서버가 유저정보를 갖고있게되면 오토스케일링으로 서버가 늘어났을때 
로드밸런스로 인해 다른서버로 들어가게 되면 세션이 끊기게 된다.
~~~
~~~
sticky session - 로그인 세션 문제 해결 But auto scaling이 밸런스있게 안됨
~~~

___출처 : https://llshl.tistory.com/47___